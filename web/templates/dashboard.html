<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Graph Search</title>
    <meta name="viewport" content="width=device-width",
    initial-scale=1">
    <link href="{{ url_for('static',
    filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link rel="shortcut icon" href="{{ url_for('static',
    filename='gs_icon.ico') }}">
</head>
<header>
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
      <img style="max-width:120px; margin-top: -7px;" src="{{ url_for('static', filename='images/GS_logo.png') }}">
      </a>
    </div>
</header>
<body>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script> 
    <div class="row">
      <div class="col-lg-6">
        <div class="input-group" style="margin-top: 15px;">
          <input type="text" class="form-control" name="searchInput" placeholder="Search for...">
          <span class="input-group-btn">
            <a href='#' id=process_input><button class="btn btn-default" value="Send" type="submit">Search!</button></a>
          </span>
        </div><!-- /input-group -->
      </div><!-- /.col-lg-6 -->
    </div><!-- /.row -->
    </div>
<div id="chart" class="container-fluid" align="center" style="margin-top: 10px; margin-left: 20px; min-height: 100%"></div> 
<script type="text/javascript">

    $(function() {
        $('a#process_input').bind('click', function() {
            $.getJSON('/_graphdata', {
            searchInput: $('input[name="searchInput"]').val(),
            }, function(data) {
                d3.selectAll("svg > *").remove();
                var jsonGraph = data.result;
		        update(jsonGraph.nodes, jsonGraph.links);
                });
        return false;
        });
    });
 			var width = 1500,
			    height = 650,
				fill = d3.scale.category20(),
				radius = 7;

			var svg = d3.select("#chart")
                .append("svg")
			    .attr("width", width)
				.attr("height", height);

            var force;

            //scale to be applied to the radius, ranging from 2 to 15px
            var rScale = d3.scale.linear().range([2, 50]);
            //colour scale
            var edgeColScale = d3.scale.linear().range(["teal", "blue"]);
            //edge width scale
            var edgeWScale = d3.scale.linear().range([1, 3]);
            //color scale for clustering acordingly
            var colScale = d3.scale.category20b();
            //sort alphabetically
            var xScale = d3.scale.linear().domain(["a".charCodeAt(0), "z".charCodeAt(0)]).range([10, width-10]);
            //higher valuer on top, smaller on bottom
            var yScale = d3.scale.linear().range([0+50, height-30])

            function update(nodes, links){
                force = d3.layout.force()
                .nodes(nodes)
                .links(links)
                .size([width, height])
                .linkDistance(40)
                .linkStrength(0.5)
                .charge(-50)
                .gravity(0.1)
                .on("tick", tick)
                .start();

                rScale.domain(d3.extent( nodes, function(d){ return d.value; }));
                edgeColScale.domain(d3.extent( links, function(d){ return d.value; }));
                edgeWScale.domain(d3.extent( links, function(d){ return d.value; }));
                yScale.domain(d3.extent( nodes, function(d){ return d.value; }));

                var edge = svg.append("svg:g").selectAll("line")
                    .data(force.links())
                    .enter()
                    .append("svg:line")
                    .attr("class", function(d){ return "link";})
                    .attr("marker-end", function(d){ return "url(#" + d.type + ")";})
                    .style("stroke", function(d){ return edgeColScale(d.value); })
                    .style("stroke-width", function(d){ return edgeWScale(d.value); });

                var circle = svg.append("svg:g").selectAll("circle")
                    .data(force.nodes())
                    .enter().append("svg:circle")
                    .attr("r", radius)
                    .call(force.drag)
                    .style("fill", function(d) { return fill(d.group); })
                    .on("mouseover", handleMouseOver)
				    .on("mouseout", handleMouseOut);

                var text = svg.append("svg:g").selectAll("g")
                    .data(force.nodes())
                    .enter().append("svg:g")
                    .style("opacity", 1)

                text.append("svg:text")
                    .attr("x", 12)
                    .attr("y", "31em")
                    .attr("class", "shadow")
                    .text(function(d) { return d.name; })
				    .style("visibility", handleVisibility);

                function transform(d) {
                    return "translate(" + d.x + "," + d.y + ")";
                    };

                function linkArc(d) {
                    var dx = d.target.x - d.source.x,
                        dy = d.target.y - d.source.y,
                        dr = Math.sqrt(dx * dx + dy * dy);
                    return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + "0 0,1 " + d.target.x + "," + d.target.y;
                    };
			
			    function handleMouseOver(d) {
				    d3.select(this).select("text").style({
					    visibility: "visible"
				    })
				    d3.select(this).select("circle").style({
					    fill: "orange"
				    })
				    d3.select(this).select("circle").attr({
					    r: radius*2
				    })
			    }

			    function handleMouseOut(d) {
				    d3.select(this).select("text").style({
					    visibility: handleVisibility
				    })
				    d3.select(this).select("circle").style({
					    fill: function(d) { return fill(d.group); }
				    })
				    d3.select(this).select("circle").attr({
					    r: radius
				    })
			    }

			    function handleVisibility(d) {
				    if (d.group == "Searched") {
					    return "visible";
				    } else {
					    return "hidden";
				    }
                    }

                function tick(e){
                    edge.attr("d", linkArc);
                    circle.attr("transform", transform);
                    text.attr("transform", transform);
                    };
            }


    </script>

</body>


</html>